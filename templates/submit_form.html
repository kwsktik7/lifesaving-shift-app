{% extends "base.html" %}

{% block title %}希望シフト一括提出{% endblock %}

{% block content %}
<article>
    <header>
        <h2>希望シフト一括提出</h2>
        <p>名前を選択すると、過去の提出状況が読み込まれます。まとめて希望を提出してください。</p>
    </header>

    <!-- STEP 1: 名前を選択するフォーム -->
    <form method="GET" action="{{ url_for('submit_availability') }}">
        <label for="member">名前を選択:</label>
        <select name="member_id" id="member" onchange="this.form.submit()">
            <option value="">-- メンバーを選択 --</option>
            {% for member in members %}
            <option value="{{ member.id }}" {% if member.id == selected_member_id %}selected{% endif %}>
                {{ member.name }} ({{ member.grade }}年)
            </option>
            {% endfor %}
        </select>
    </form>

    <!-- 名前が選択されたら、STEP 2のシフト提出フォームを表示 -->
    {% if selected_member_id %}
    <hr>
    <h3>{{ selected_member_name }} さんの希望シフト</h3>
    
    <!-- 提出完了メッセージなどを表示 -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <p style="color: green;"><b>{{ message }}</b></p>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- STEP 2: シフトをまとめて提出するフォーム -->
    <form method="POST" action="{{ url_for('submit_availability') }}">
        <!-- 選択中のメンバーIDを隠しデータとして送信 -->
        <input type="hidden" name="member_id" value="{{ selected_member_id }}">
        
        <table>
            <thead>
                <tr>
                    <th>日付</th>
                    <th>曜日</th>
                    <th>希望</th>
                </tr>
            </thead>
            <tbody>
                <!-- Pythonから渡された日付リストをループ処理 -->
                {% for day in days %}
                <tr>
                    <td>{{ day.date.strftime('%Y-%m-%d') }}</td>
                    <td>{{ day.weekday }}</td>
                    <td>
                        <fieldset>
                            <label style="display: inline-block; margin-right: 10px;">
                                <input type="radio" name="availability_{{ day.date.strftime('%Y-%m-%d') }}" value="full_day" 
                                {% if availability.get(day.date.strftime('%Y-%m-%d')) == 'full_day' %}checked{% endif %}> 1日
                            </label>
                            <label style="display: inline-block; margin-right: 10px;">
                                <input type="radio" name="availability_{{ day.date.strftime('%Y-%m-%d') }}" value="am_only"
                                {% if availability.get(day.date.strftime('%Y-%m-%d')) == 'am_only' %}checked{% endif %}> 午前
                            </label>
                            <label style="display: inline-block; margin-right: 10px;">
                                <input type="radio" name="availability_{{ day.date.strftime('%Y-%m-%d') }}" value="pm_only"
                                {% if availability.get(day.date.strftime('%Y-%m-%d')) == 'pm_only' %}checked{% endif %}> 午後
                            </label>
                            <label style="display: inline-block;">
                                <input type="radio" name="availability_{{ day.date.strftime('%Y-%m-%d') }}" value="unavailable"
                                {% if not availability.get(day.date.strftime('%Y-%m-%d')) or availability.get(day.date.strftime('%Y-%m-%d')) == 'unavailable' %}checked{% endif %}> 不可
                            </label>
                        </fieldset>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <br>
        <button type="submit">全ての希望をまとめて提出する</button>
    </form>
    {% endif %}
</article>
{% endblock %}